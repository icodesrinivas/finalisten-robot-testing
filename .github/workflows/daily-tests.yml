name: Daily Robot Framework Tests

# Schedule: Runs at midnight IST (6:30 PM UTC = 12:00 AM IST)
on:
  schedule:
    - cron: '30 18 * * *'  # 00:00 IST daily
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  robot-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install and setup Chrome
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable
      
      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2
      
      - name: Run Robot Framework tests
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          robot --variable CHROME_OPTIONS:"add_argument('--headless');add_argument('--no-sandbox');add_argument('--disable-gpu');add_argument('--disable-dev-shm-usage');add_argument('--window-size=1920,1080')" \
                --outputdir results \
                --xunit results.xml \
                FinalistenTestCases/
        continue-on-error: true
      
      - name: Generate test summary
        if: always()
        run: |
          echo "# Robot Framework Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f results/output.xml ]; then
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import xml.etree.ElementTree as ET
          tree = ET.parse('results/output.xml')
          root = tree.getroot()
          stats = root.find('.//statistics/total/stat')
          if stats is not None:
              total = stats.get('pass', '0') + stats.get('fail', '0')
              passed = stats.get('pass', '0')
              failed = stats.get('fail', '0')
              print(f'- **Total Tests:** {total}')
              print(f'- **Passed:** ✅ {passed}')
              print(f'- **Failed:** ❌ {failed}')
          EOF
          else
            echo "⚠️ No test results found" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: robot-test-results-${{ github.run_number }}
          path: |
            results/*.html
            results/*.xml
          retention-days: 30
      
      - name: Parse test results for email
        if: always()
        id: test-results
        run: |
          if [ -f results/output.xml ]; then
            TOTAL=$(python3 -c "import xml.etree.ElementTree as ET; tree = ET.parse('results/output.xml'); root = tree.getroot(); stats = root.find('.//statistics/total/stat'); print(int(stats.get('pass', 0)) + int(stats.get('fail', 0)))")
            PASSED=$(python3 -c "import xml.etree.ElementTree as ET; tree = ET.parse('results/output.xml'); root = tree.getroot(); stats = root.find('.//statistics/total/stat'); print(stats.get('pass', '0'))")
            FAILED=$(python3 -c "import xml.etree.ElementTree as ET; tree = ET.parse('results/output.xml'); root = tree.getroot(); stats = root.find('.//statistics/total/stat'); print(stats.get('fail', '0'))")
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
            if [ "$FAILED" -gt 0 ]; then
              echo "status=FAILED" >> $GITHUB_OUTPUT
            else
              echo "status=SUCCESS" >> $GITHUB_OUTPUT
            fi
            
            # Extract failing test details as HTML table
            cat > extract_failures.py << 'PYEOF'
          import xml.etree.ElementTree as ET
          import html
          
          tree = ET.parse('results/output.xml')
          root = tree.getroot()
          
          failed_tests = []
          for test in root.iter('test'):
              status = test.find('status')
              if status is not None and status.get('status') == 'FAIL':
                  test_name = test.get('name', 'Unknown Test')
                  doc_elem = test.find('doc')
                  doc = doc_elem.text if doc_elem is not None and doc_elem.text else 'No description available'
                  error_msg = status.text if status.text else 'Test failed'
                  if len(error_msg) > 150:
                      error_msg = error_msg[:150] + '...'
                  if len(doc) > 200:
                      doc = doc[:200] + '...'
                  failed_tests.append((html.escape(test_name), html.escape(doc), html.escape(error_msg)))
          
          if failed_tests:
              print('<h3 style="color: red;">❌ Failed Test Cases:</h3>')
              print('<table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%;">')
              print('<tr style="background-color: #f2f2f2;"><th style="text-align: left;">Test Name</th><th style="text-align: left;">Description</th><th style="text-align: left;">Error</th></tr>')
              for name, doc, error in failed_tests:
                  print(f'<tr><td style="font-weight: bold;">{name}</td><td>{doc}</td><td style="color: red;">{error}</td></tr>')
              print('</table>')
          PYEOF
            python3 extract_failures.py > failed_tests.html
            
            # Read and set output
            {
              echo "failed_tests_html<<ENDHTML"
              cat failed_tests.html
              echo "ENDHTML"
            } >> $GITHUB_OUTPUT
          else
            echo "total=0" >> $GITHUB_OUTPUT
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "status=ERROR" >> $GITHUB_OUTPUT
            echo "failed_tests_html=" >> $GITHUB_OUTPUT
          fi
      
      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        if: always()
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'Robot Framework Test Results - ${{ steps.test-results.outputs.status }} - Run #${{ github.run_number }}'
          to: srinivas8862@gmail.com,otso.nieminen@finalisten.se
          from: ${{ secrets.EMAIL_USERNAME }}
          html_body: |
            <h2>Robot Framework Test Execution Report</h2>
            <p><strong>Build:</strong> #${{ github.run_number }}</p>
            <p><strong>Status:</strong> <span style="color: ${{ steps.test-results.outputs.status == 'SUCCESS' && 'green' || 'red' }};">${{ steps.test-results.outputs.status }}</span></p>
            <p><strong>Date:</strong> ${{ github.event.repository.updated_at }}</p>
            <p><strong>Triggered by:</strong> ${{ github.event_name }}</p>
            
            <h3>Test Results Summary:</h3>
            <ul>
                <li><strong>Total Test Cases:</strong> ${{ steps.test-results.outputs.total }}</li>
                <li><strong>Passed:</strong> <span style="color: green;">✅ ${{ steps.test-results.outputs.passed }}</span></li>
                <li><strong>Failed:</strong> <span style="color: red;">❌ ${{ steps.test-results.outputs.failed }}</span></li>
            </ul>
            
            ${{ steps.test-results.outputs.failed_tests_html }}
            
            <p><strong>GitHub Actions Run:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}</a></p>
            <p><strong>Repository:</strong> <a href="${{ github.server_url }}/${{ github.repository }}">${{ github.repository }}</a></p>
            
            <hr/>
            <p style="font-size: 12px; color: gray;">This is an automated message from GitHub Actions - Robot Framework Tests</p>
          attachments: results/report.html,results/log.html
          ignore_cert: true
          convert_markdown: false
